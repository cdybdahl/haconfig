#################################################################
## Automations
#################################################################

#################################################################
## The house talks to us
#################################################################
  - id: dailyDybdahl
    alias: 'TALK: Daily Dybdahl'
    trigger:
      - platform: state
        entity_id: light.linear_wd500z1_wall_dimmer_switch_level
        to: "on"
    condition:
      - condition: time
        after: '07:00:00'
        before: '20:00:00'
    action:
      - service: script.turn_on
        entity_id: script.greeting
      - service: scene.turn_on
        entity_id: scene.kitchen_day

  - id: tonyaCommuteMorning
    alias: 'TALK: Tonya morning commute'
    trigger:
      - platform: time
        at: '07:20:00'
    condition:
      - condition: time
        weekday:
          - mon
          - tue
          - wed
          - thu
          - fri
    action:
      - service: notify.slack
        data_template:
          message: >
            Good morning Wiggly. You commute should be {{states('sensor.home_to_work')}} minutes today.

  - id: tonyaCommuteEvening
    alias: 'TALK: Tonya evening commute'
    trigger:
      - platform: time
        at: '16:25:00'
    condition:
      - condition: time
        weekday:
          - mon
          - tue
          - wed
          - thu
          - fri
    action:
      - service: notify.slack
        data_template:
          message: >
            Good afternnon Wiggly. Your ride home is {{states('sensor.work_to_home')}} minutes today.

#################################################################
## Football time
#################################################################
  - id: turnOnFootballAutomations
    alias: 'HT: Turn football on'
    trigger:
      - platform: time
        at: '00:00:00'
      - platform: event
        event_type: homeassistant_start
    condition:
      - condition: or
        conditions:
          - condition: state
            entity_id: sensor.current_month
            state: 'September'
          - condition: state
            entity_id: sensor.current_month
            state: 'October'   
          - condition: state
            entity_id: sensor.current_month
            state: 'November'
          - condition: state
            entity_id: sensor.current_month
            state: 'December'  
          - condition: state
            entity_id: sensor.current_month
            state: 'January'
    action:
      - service: automation.turn_on
        entity_id: group.football_automations      

  - id: turnOffFootballAutomations
    alias: 'HT: Turn football off'
    trigger:
      - platform: time
        at: '00:00:00'
      - platform: event
        event_type: homeassistant_start
    condition:
      - condition: or
        conditions:
          - condition: state
            entity_id: sensor.current_month
            state: 'February'
          - condition: state
            entity_id: sensor.current_month
            state: 'March'   
          - condition: state
            entity_id: sensor.current_month
            state: 'April'
          - condition: state
            entity_id: sensor.current_month
            state: 'May'  
          - condition: state
            entity_id: sensor.current_month
            state: 'June'
          - condition: state
            entity_id: sensor.current_month
            state: 'July'  
          - condition: state
            entity_id: sensor.current_month
            state: 'August'
    action:
      - service: automation.turn_off
        entity_id: group.football_automations          
        
  - id: footballSunday
    alias: 'HT: Football Sunday'
    initial_state: 'off'
    trigger:
      - platform: time
        at: '11:30:00'
    condition: 
      - condition: and
        conditions:
          - condition: state
            entity_id: group.chadtonya
            state: home
          - condition: time
            weekday:
              - sun
    action:
      - service: tts.google_say
        entity_id: media_player.kitchen_home
        data:
          message: "30 minutes to sunday football! Grab a bloody mary and park your butt on the couch. I'm getting things ready."
      - service: script.turn_on
        entity_id: script.tv
        
  - id: footballSundayGetHome
    alias: 'HT: Football Sunday Get Home'
    initial_state: 'off'
    trigger:
      - platform: state
        entity_id: group.chadtonya
        to: home
    condition: 
      - condition: and
        conditions:
          - condition: time
            after: '12:00:00'
          - condition: time
            before: '18:30:00'
          - condition: time
            weekday:
              - sun
    action:
      - service: script.turn_on
        entity_id: script.tv
      - delay: 00:01:30
      - service: tts.google_say
        entity_id: media_player.kitchen_home
        data:
          message: "Looks like you guys just got home and football is happening. I turned the game on for you."
          
  - id: footballSundayNightGetHome
    alias: 'HT: Football Sunday Night Get Home'
    initial_state: 'off'
    trigger:
      - platform: state
        entity_id: group.chadtonya
        to: home
    condition: 
      - condition: and
        conditions:
          - condition: time
            after: '07:01:00'
          - condition: time
            before: '22:00:00'
          - condition: time
            weekday:
              - sun
    action:
      - service: script.turn_on
        entity_id: script.tv
      - service: remote.send_command
        entity_id: remote.den
        data:
          device: 45943852
          command: ['4','NumberEnter']
      - delay: 00:01:30
      - service: tts.google_say
        entity_id: media_player.kitchen_home
        data:
          message: "Looks like you guys just got home and football is happening. I turned the game on for you."
          
  - id: footballSundayNight
    alias: 'HT: Football Sunday Night'
    initial_state: 'off'
    trigger:
      - platform: time
        at: '19:00:00'
    condition: 
      - condition: and
        conditions:
          - condition: state
            entity_id: group.chadtonya
            state: home
          - condition: time
            weekday:
              - sun
    action:
      - service: tts.google_say
        entity_id: media_player.kitchen_home
        data:
          message: "It's time for Sunday night football. I'm getting things ready for you."
      - service: script.turn_on
        entity_id: script.tv
      - service: remote.send_command
        entity_id: remote.den
        data:
          device: 45943852
          command: ['4','NumberEnter']
   
  - id: footballMonday
    alias: 'HT: Football Monday'
    initial_state: 'off'
    trigger:
      - platform: time
        at: '19:10:00'
    condition: 
      - condition: and
        conditions:
          - condition: state
            entity_id: group.chadtonya
            state: home
          - condition: time
            weekday:
              - mon
    action:
      - service: tts.google_say
        entity_id: media_player.kitchen_home
        data:
          message: "Are you ready for some football?"
      - service: script.turn_on
        entity_id: script.roku
      - service: media_player.select_source
        data:
          entity_id: media_player.roku_4e756g050640
          source: 'WatchESPN' 
      - delay: 00:00:10
      - service: remote.send_command
        entity_id: remote.den
        data:
          device: 45943853
          command: 'Play'
      - delay: 00:00:03
      - service: remote.send_command
        entity_id: remote.den
        data:
          device: 45943853
          command: 'Play'          
          
  - id: footballMondayGetHome
    alias: 'HT: Football Monday Get Home'
    initial_state: 'off'
    trigger:
      - platform: state
        entity_id: group.chadtonya
        to: home
    condition: 
      - condition: and
        conditions:
          - condition: time
            after: '19:10:01'
          - condition: time
            before: '22:00:00'
          - condition: time
            weekday:
              - mon
    action:
      - service: script.turn_on
        entity_id: script.roku
      - service: media_player.select_source
        data:
          entity_id: media_player.roku_4e756g050640
          source: 'WatchESPN' 
      - service: remote.send_command
        entity_id: remote.den
        data:
          device: 45943853
          command: 'Play'
      - delay: 00:00:03
      - service: remote.send_command
        entity_id: remote.den
        data:
          device: 45943853
          command: 'Play'
      - delay: 00:01:30
      - service: tts.google_say
        entity_id: media_player.kitchen_home
        data:
          message: "Looks like you guys just got home and football is happening. I turned the game on for you."
   
  - id: footballThursday
    alias: 'HT: Football Thursday'
    initial_state: 'off'
    trigger:
      - platform: time
        at: '19:00:00'
    condition: 
      - condition: and
        conditions:
          - condition: state
            entity_id: group.chadtonya
            state: home
          - condition: time
            weekday:
              - thu
    action:
      - service: tts.google_say
        entity_id: media_player.kitchen_home
        data:
          message: "It's Thursday night football time! Launching amazon video."
      - service: script.turn_on
        entity_id: script.roku
      - service: media_player.select_source
        data:
          entity_id: media_player.roku_4e756g050640
          source: 'Amazon Video'

  - id: footballThursdayGetHome
    alias: 'HT: Football Thursday Get Home'
    initial_state: 'off'
    trigger:
      - platform: state
        entity_id: group.chadtonya
        to: home
    condition: 
      - condition: and
        conditions:
          - condition: time
            after: '19:00:01'
          - condition: time
            before: '22:00:00'
          - condition: time
            weekday:
              - thu
    action:
      - service: script.turn_on
        entity_id: script.roku
      - service: media_player.select_source
        data:
          entity_id: media_player.roku_4e756g050640
          source: 'Amazon Video' 
      - delay: 00:01:30
      - service: tts.google_say
        entity_id: media_player.kitchen_home
        data:
          message: "Looks like you guys just got home and football is happening. I turned the game on for you."      
          
#################################################################
## Lights
#################################################################
# Front door light timer
  - id: porchLightOn
    alias: 'LIGHT: Turn on front door at sunset'
    trigger:
      - platform: sun
        event: sunset
        offset: '-00:20:00'
    action:
      - service: light.turn_on
        entity_id: light.front_door

  - id: porchLightOff
    alias: 'LIGHT: Turn off front door at sunrise'
    trigger:
      - platform: sun
        event: sunrise
        offset: "+00:20:00"
    action:
      - service: light.turn_off
        entity_id: light.front_door

# Office light timer
  - id: officeLightOn
    alias: 'LIGHT: Turn on office lights when working'
    trigger:
      platform: time
      at: '07:20:00'
    condition: 
      - condition: and
        conditions:
          - condition: state
            entity_id: device_tracker.chadsPhone
            state: home
          - condition: time
            weekday:
              - mon
              - tue
              - wed
              - thu
              - fri
    action:
      - service: light.turn_on
        entity_id: group.office_lights

  - id: officeLightOff
    alias: 'LIGHTS: Turn office lights off at EOD'
    trigger:
      - platform: time
        at: '16:30:00'
    condition:
      - condition: time
        weekday:
          - mon
          - tue
          - wed
          - thu
          - fri     
    action:
      - service: light.turn_off
        entity_id: group.office_lights

# Turn off den lights when Roku starts playing after dark
  - id: movieScene
    alias: "SCENE: Media player playing"
    trigger:
      - platform: state
        entity_id: remote.den
        from: 'off'
    condition:
      - condition: time
        after: '18:00:00'
    action:
      - service: scene.turn_on
        entity_id: scene.den_movie

# Turn on den lights when Chad or Tonya come home after dark
  - id: denLightsOn
    alias: "LIGHT: Someone came home at night"
    trigger:
      - platform: state
        entity_id: group.chadtonya
        from: 'not_home'
        to: 'home'
    condition:
      - condition: state
        entity_id: sun.sun
        state: 'below_horizon'
      - condition: time
        before: '23:00'
    action:
      - service: scene.turn_on
        entity_id: scene.den_normal

# Turn lights off after Veda leaves in the morning
  - id: lightsOffVeda
    alias: 'LIGHT: Turn off lights when veda leaves'
    trigger:
      - platform: state
        entity_id: device_tracker.vedasiphone
        to: "not home"
    condition: 
      - condition: and
        conditions:
          - condition: state
            entity_id: binary_sensor.upstairs_occupancy
            state: "off"
          - condition: time
            before: '07:30'
    action:
      - service: light.turn_off
        entity_id: group.downstairs_lights  

# Set morning scene
  - id: morningScene
    alias: 'SCENE: Morning'
    trigger:
      - platform: time
        at: '06:20:00'
    condition: 
      - condition: time
        weekday:
          - mon
          - tue
          - wed
          - thu
          - fri
    action:
      - service: lock.unlock
        entity_id: lock.front_door_deadbolt_locked
      - service: scene.turn_on
        entity_id: scene.morning_weekday          

#################################################################
## Windows
#################################################################        
  - id: windowOpened
    alias: "WINDOW: Kitchen opened"
    trigger:
      - platform: state
        entity_id: sensor.kitchen_sliding_window
        to: "Open"
    action:
      - service: tts.google_say
        entity_id: media_player.kitchen_home
        data:
          message: "The kitchen sliding window has been opened. Setting thermostat to away mode."
      - service: climate.set_away_mode
        data:
          entity_id: climate.thermostat
          away_mode: true
          
  - id: windowClosed
    alias: "WINDOW: Kitchen closed"
    trigger:
      - platform: state
        entity_id: sensor.kitchen_sliding_window
        to: "Closed"
    action:
      - service: tts.google_say
        entity_id: media_player.kitchen_home
        data:
          message: "The kitchen sliding window has been closed. Resuming normal thermostat settings."
      - service: climate.set_away_mode
        data:
          entity_id: climate.thermostat
          away_mode: false
          
#################################################################
## Presence detection
#################################################################
  - id: chadHome
    alias: "PRESENCE: Chad just got home"
    trigger:
      - platform: state
        entity_id: device_tracker.chadsPhone
        from: "not_home"
        to: "home"
    condition:
      - condition: time
        before: '23:00'
    action:
      - service: tts.google_say
        entity_id: media_player.kitchen_home
        data:
          message: "Chad is home."
      - service: notify.slack
        data:
          message: "Hey guys, Chad just got home."
    
  - id: tonyaHome
    alias: "PRESENCE: Tonya just got home"
    trigger:
      - platform: state
        entity_id: device_tracker.tonyasPhone
        from: "not_home"
        to: "home"
    condition:
      - condition: time
        before: '21:00'
    action:
      - service: tts.google_say
        entity_id: media_player.chads_office, media_player.kitchen_home
        data:
          message: "Wiggly is home."
      - service: notify.slack
        data:
          message: "Hey guys, Wiggly just got home."

  - id: vedaHome
    alias: "PRESENCE: Veda just got home"
    trigger:
      - platform: state
        entity_id: device_tracker.vedasiphone
        from: "not_home"
        to: "home"
    action:
      - service: tts.google_say
        entity_id: media_player.chads_office, media_player.kitchen_home
        data:
          message: "Veda is home."
          action:
      - service: notify.slack
        data:
          message: "Hey guys, Veda just got home."

  - id: tonyaLeavingWork
    alias: "PRESENCE: Tonya just left work"
    trigger:
      - platform: state
        entity_id: device_tracker.bmwx3_bmwx3
        from: "Work"
        to: "not_home"
    action:
      - service: tts.google_say
        entity_id: media_player.chads_office, media_player.kitchen_home
        data_template:
          message: >
            Wiggly is leaving work. She'll be home in {{states('sensor.work_to_home')}} minutes.
      - service: notify.slack
        data_template:
          message: >
            Hey guys, Wiggly is heading home from work. She'll be home in {{states('sensor.work_to_home')}} minutes.

#################################################################
## Away mode
#################################################################
  - id: awayMode
    alias: 'AWAY: Turn things off when away'
    trigger:
      platform: state
      entity_id: group.family
      to: 'not_home'
    action:
      - service: climate.set_away_mode
        data:
          entity_id: climate.thermostat
          away_mode: true
      - service: light.turn_off
        entity_id: group.downstairs_lights, group.upstairs_lights
      - service: remote.turn_off
        entity_id: remote.den
      - service: lock.lock
        entity_id: lock.front_door_deadbolt_locked
      - service: notify.slack
        data:
          message: "You guys left, so I'm shutting the house down."

  - id: vedaDetectionOn
    alias: 'AWAY: Presence for Veda on when away'
    trigger:
      platform: state
      entity_id: group.chadTonya
      to: 'not_home'
    action:
      - service: automation.turn_on
        entity_id: automation.presence_veda_just_got_home

  - id: vedaDetectionOff
    alias: 'AWAY: Presence for Veda off when home'
    trigger:
      platform: state
      entity_id: group.chadTonya
      to: 'home'
    action:
      - service: automation.turn_off
        entity_id: automation.presence_veda_just_got_home
  
  - id: returnFromAway
    alias: 'AWAY: Return from away mode'
    trigger:
      platform: state
      entity_id: group.family
      to: 'home'
    action:
      - service: climate.set_away_mode
        data:
          entity_id: climate.thermostat
          away_mode: false
      - service: scene.turn_on
        entity_id: scene.morning_weekday
      - service: notify.slack
        data:
          message: "You guys got back, returning to normal operation."
      - delay: '00:02:00'
      - service: tts.google_say
        entity_id: media_player.chads_office, media_player.kitchen_home
        data:
          message: "Welcome back! I've turned off away mode."
  
  - id: vacationOn
    alias: 'VACATION: Turn on lights at night'
    initial_state: 'off'
    trigger:
      platform: time
      at: '18:30:00'
    action:
      - service: light.turn_on
        entity_id: group.downstairs_lights
      - service: notify.slack
        data:
          message: "Vacation lights on."
        
  - id: vacationOff
    alias: 'VACATION: Turn lights off at bedtime'
    initial_state: 'off'
    trigger:
      platform: time
      at: '22:53:00'
    action:
      - service: light.turn_off
        entity_id: group.downstairs_lights
      - service: notify.slack
        data:
          message: "Vacation lights off."
          
# Turn vacation mode on when nobody is home for 18 hours
  - id: vacationMode
    alias: 'VACATION: Turn on vacation mode when no one is home'
    trigger:
      platform: state
      entity_id: group.family
      to: 'not_home'
      for: 
        hours: 12
    action:
      - service: automation.turn_on
        entity_id: automation.vacation_turn_on_lights_at_night
      - service: automation.turn_on
        entity_id: automation.vacation_turn_lights_off_at_bedtime
      - service: climate.set_away_mode
        data:
          entity_id: climate.thermostat
          away_mode: true
      - service: notify.slack
        data:
          message: "Nobody is home, so I'm turning on vacation mode."
          
  - id: vacationModeOff
    alias: 'VACATION: Turn off vacation mode when people return home'
    trigger:
      platform: state
      entity_id: group.family
      to: 'home'
    condition:
      condition: template
      value_template: '{{ states.climate.thermostat.attributes.away_mode == on }}'
    action:
      - service: automation.turn_off
        entity_id: automation.vacation_turn_on_lights_at_night
      - service: automation.turn_off
        entity_id: automation.vacation_turn_lights_off_at_bedtime
      - service: climate.set_away_mode
        data:
          entity_id: climate.thermostat
          away_mode: false
      - service: notify.slack
        data:
          message: "Welcome back! I've turned off vacation mode. Hopefully Kevin is still alive."
      - delay: '00:03:00'
      - service: tts.google_say
        entity_id: media_player.chads_office, media_player.kitchen_home
        data:
          message: "Welcome back! I've turned off vacation mode. Hopefully Kevin is still alive."
        

#################################################################
## Sensors
#################################################################        
# Monitor home humidity
  - id: humidityWarn
    alias: 'SENSOR: Humidity warning' 
    trigger:
     -  platform: numeric_state
        entity_id: sensor.home_humidity
        below: 30
    action:
      - service: notify.slack
        data:
          message: "The humidity is too low. Check the humidifier."

  - id: humidityBetter
    alias: 'SENSOR: Humidity back up' 
    trigger:
      - platform: numeric_state
        entity_id: sensor.home_humidity
        above: 25
    action:
      - service: notify.slack
        data:
          message: "Cool, humidity is back up!"
          
# Warn me when smoke detector batteries get low
  - id: detectorBattery
    alias: "SENSOR: Basement stairs battery low"
    trigger:
      - platform: numeric_state
        entity_id: sensor.batt_smoke1
        below: 25
    action:
      - service: notify.slack
        data:
          message: "Better replace the batteries in the smoke alarm!"

# Notify Chad and Tonya when smoke alarm goes off
  - id: smokeAlarm
    alias: "SENSOR: Basement stairs smoke alarm"
    trigger:
      - platform: state
        entity_id: sensor.smoke1
        to: "ALERT!"
    action:
      - service: notify.slack
        data:
          message: "ALERT! ALERT! Smoke detector activated!"

# Warn me when flood sensor batteries are low
  - id: sumpBattery
    alias: "SENSOR: Sump low battery"
    trigger:
      - platform: numeric_state
        entity_id: sensor.batt_sump
        below: 25
    action:
      - service: notify.slack
        data:
          message: "Replace sump flood detector batteries."

# Notify when water gets too high in the sump  
  - id: sumpWater
    alias: "SENSOR: Water detected in basement"
    trigger:
     - platform: numeric_state
       entity_id: sensor.everspring_st812_flood_detector_flood_5_5
       above: 1
    action:
      - service: persistent_notification.create
        data:
         message: "Check the sump pump."
         title: "Water level high!"
         notification_id: 1
      - service: notify.slack
        data:
          message: "Uh-oh. Looks like the sump pump isn't doing its job."

#################################################################
## Switches
#################################################################   

# Turn on WEMO switch. Currently used for electric blanket
  - id: wemoOn
    alias: 'SWITCH: Turn on WEMO at 21:00'
    trigger:
      - platform: time
        at: '08:00:00'
    action:
      - service: switch.turn_on
        entity_id: switch.the_tree

  - id: wemoOff
    alias: 'SWITCH: Turn off WEMO at 11:00'
    trigger:
      - platform: time
        at: '17:00:00'
    action:
      - service: switch.turn_off
        entity_id: switch.the_tree

#################################################################
## Homeassistant stuff
#################################################################   
        
# Notify me when a Homeassistant update is available
  - id: haUpdate 
    alias: 'HOMEASSISTANT: Update Available Notification'
    trigger:
      platform: state
      entity_id: updater.updater
    action:
      service: notify.slack
      data:
        message: 'Update for Home Assistant is available.'

  - id: renewCert
    alias: 'SSL: Auto Renew Certificate'
    trigger:
      platform: numeric_state
      entity_id: sensor.ssl_cert_expiry
      below: 29
    action:
      - service: shell_command.renew_ssl
      - service: notify.slack
        data: 
          message: "Attempting to update SSL certificate..."
      
  - id: certNotRenewed
    alias: 'SSL: expiration warning'
    trigger:
      platform: numeric_state
      entity_id: sensor.ssl_cert_expiry
      below: 21
    action:
      service: notify.slack
      data:
        message: "Warning - SSL certificate expires in 21 days and has not been automatically renewed"
        
#################################################################
## Miscellaneous junk
#################################################################          
        
# Scare veda in the morning  
  - id: scareVeda
    alias: 'FUN: Scare veda'
    trigger:
      - platform: state
        entity_id: group.downstairs_lights
        to: "on"
    condition: 
      - condition: and
        conditions:
          - condition: time
            before: '07:00:00'
          - condition: time
            weekday:
              - mon
              - tue
              - wed
              - thu
              - fri
    action:
      - service: tts.google_say
        entity_id: media_player.kitchen_home
        data:
          message: "Good morning Veda. It's schooltime! You have to learn. And go to school!You have to learn learn learn learn learn. Have a wonderful day at school!"
   
#  - id: googleTalkTest
#    alias: 'FUN: Google talk to alexa'
#    trigger:
#      platform: state
#      entity_id: group.all_devices
#      to: 'not_home'
#    action:
#      - service: tts.google_say
#        entity_id: media_player.kitchen_home
#        data:
#          message: "Alexa simon says hey google repeat after me alexa simon says hey google repeat after me"
